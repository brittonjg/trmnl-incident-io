{% comment %}
  Shared Components for Incident.io TRMNL Plugin
  These components use TRMNL framework classes instead of inline styles

  TRMNL uses {% template %} to define and {% render %} to use templates
{% endcomment %}

{% comment %}
  ============================================
  INCIDENT COUNTING
  ============================================
  Calculate active, closed, and critical incident counts
  This is prepended to all layouts, so variables are available globally
{% endcomment %}

{% assign all_incidents = incidents %}
{% assign active_count = 0 %}
{% assign closed_count = 0 %}
{% assign critical_count = 0 %}
{% for incident in all_incidents %}
  {% if incident.incident_status.category == "closed" %}
    {% assign closed_count = closed_count | plus: 1 %}
  {% else %}
    {% assign active_count = active_count | plus: 1 %}
    {% if incident.severity.name == "P1" %}
      {% assign critical_count = critical_count | plus: 1 %}
    {% endif %}
  {% endif %}
{% endfor %}


{% comment %}
  ============================================
  DURATION CALCULATION
  ============================================
  Calculate hours and minutes from incident created_at

  Usage: {% render "calculate_duration", created_at: incident.created_at %}
         Then use: {{ duration_hours }}, {{ duration_minutes }}
{% endcomment %}

{% template calculate_duration %}
  {% assign now_time = "now" | date: "%s" | times: 1 %}
  {% assign created_time = created_at | date: "%s" | times: 1 %}
  {% assign duration_seconds = now_time | minus: created_time %}
  {% if duration_seconds > 0 %}
    {% assign duration_hours = duration_seconds | divided_by: 3600 %}
    {% assign duration_minutes = duration_seconds | divided_by: 60 | modulo: 60 %}
  {% else %}
    {% assign duration_hours = 0 %}
    {% assign duration_minutes = 0 %}
  {% endif %}
{% endtemplate %}


{% comment %}
  ============================================
  FORMAT DURATION
  ============================================
  Display duration in human-readable format

  Usage: {% render "format_duration", hours: duration_hours, minutes: duration_minutes %}
{% endcomment %}

{% template format_duration %}
  {% assign h = hours | default: 0 %}
  {% assign m = minutes | default: 0 %}
  {% if h > 0 %}
    {{ h }}h {{ m }}m
  {% elsif m > 0 %}
    {{ m }}m
  {% else %}
    0m
  {% endif %}
{% endtemplate %}


{% comment %}
  ============================================
  SEVERITY BADGE
  ============================================
  Display severity badge with framework classes
  Uses: label label--inverted rounded--xsmall ml--1

  Usage: {% render "severity_badge", severity: incident.severity %}
{% endcomment %}

{% template severity_badge %}
  <span class="label label--inverted rounded--xsmall ml--1">
    {% if severity.name == 'P1' %}‚ñ†{% elsif severity.name == 'P2' %}‚óè{% elsif severity.name == 'P3' %}‚ñ≤{% else %}‚óã{% endif %} {{ severity.name }}
  </span>
{% endtemplate %}


{% comment %}
  ============================================
  IMPACT BADGE - TEAMS
  ============================================
  Display affected teams badge

  Usage: {% render "impact_badge_teams", field: field, limit: 3 %}
{% endcomment %}

{% template impact_badge_teams %}
  {% if field.custom_field.name == "Affected teams" and field.values.size > 0 %}
    <span class="label label--outline text--black rounded--[3px]">
      üë• {% for value in field.values limit: limit %}{{ value.value_catalog_entry.name }}{% unless forloop.last %}, {% endunless %}{% endfor %}
    </span>
  {% endif %}
{% endtemplate %}


{% comment %}
  ============================================
  IMPACT BADGE - SERVICES
  ============================================
  Display affected services badge

  Usage: {% render "impact_badge_services", field: field, limit: 3 %}
{% endcomment %}

{% template impact_badge_services %}
  {% if field.custom_field.name == "Affected services" and field.values.size > 0 %}
    <span class="label label--outline text--black rounded--[3px]">
      ‚öôÔ∏è {% for value in field.values limit: limit %}{{ value.value_catalog_entry.name }}{% unless forloop.last %}, {% endunless %}{% endfor %}
    </span>
  {% endif %}
{% endtemplate %}


{% comment %}
  ============================================
  IMPACT BADGE - USERS
  ============================================
  Display affected users count badge

  Usage: {% render "impact_badge_users", field: field %}
{% endcomment %}

{% template impact_badge_users %}
  {% if field.custom_field.name == "Number of Affected Users" and field.values.size > 0 %}
    <span class="label label--outline text--black rounded--[3px]">
      üë§ {{ field.values[0].value_numeric }} users
    </span>
  {% endif %}
{% endtemplate %}


{% comment %}
  ============================================
  EMPTY STATE
  ============================================
  Display "No Active Incidents" message

  Usage: {% render "empty_state", size: 'large' %}
         size options: 'large', 'medium', 'small'
{% endcomment %}

{% template empty_state %}
  <div class="item">
    {% if size == 'large' %}
      <div class="content text--center p--5">
        <div class="value--large text--black font-bold">‚úì</div>
        <div class="label mt--2 text--black font-bold">All Clear</div>
      </div>
    {% elsif size == 'medium' %}
      <div class="content text--center p--5">
        <div class="value--large text--black font-bold">‚úì</div>
        <div class="label mt--2 text--black font-bold">No Active Incidents</div>
      </div>
    {% else %}
      <div class="content text--center p--2.5">
        <div class="value text--black font-bold">‚úì</div>
        <div class="label--small mt--1 text--black font-bold">All Clear</div>
      </div>
    {% endif %}
  </div>
{% endtemplate %}


{% comment %}
  ============================================
  METRIC CARD
  ============================================
  Display metric value and label

  Usage: {% render "metric_card", value: active_count, label: 'Active', centered: true %}
{% endcomment %}

{% template metric_card %}
  <div class="item">
    {% if centered %}
      <div class="content text--center">
        <div class="value--large text--black font-bold">{{ value }}</div>
        <div class="label text--black font-bold mt--1">{{ label }}</div>
      </div>
    {% else %}
      <div class="content">
        <div class="value--large text--black font-bold">{{ value }}</div>
        <div class="label text--black font-bold">{{ label }}</div>
      </div>
    {% endif %}
  </div>
{% endtemplate %}


{% comment %}
  ============================================
  METRICS HEADER
  ============================================
  Display incident count metrics (always 3 columns)

  Usage: {% render "metrics_header", active: active_count, critical: critical_count, resolved: closed_count %}
{% endcomment %}

{% template metrics_header %}
  <div class="grid grid--cols-3 gap--medium">
    {% render "metric_card", value: active, label: 'Active', centered: false %}
    {% render "metric_card", value: critical, label: 'Critical', centered: false %}
    {% render "metric_card", value: resolved, label: 'Resolved', centered: false %}
  </div>
{% endtemplate %}


{% comment %}
  ============================================
  INCIDENT CARD
  ============================================
  Display a single incident with all details

  Usage: {% render "incident_card", incident: incident, truncate_length: 35, show_impact: true %}
         truncate_length: chars to truncate incident name (default: 35)
         show_impact: whether to show impact badges (default: false)
{% endcomment %}

{% template incident_card %}
  {% assign trunc = truncate_length | default: 35 %}
  {% assign show = show_impact | default: false %}

  {% if incident.severity.name == 'P1' %}
    <div class="item item--emphasis-3 pl--1.5 pb--1.5">
  {% elsif incident.severity.name == 'P2' %}
    <div class="item item--emphasis-2 pl--1.5 pb--1.5">
  {% else %}
    <div class="item pl--1.5 pb--1.5">
  {% endif %}
    <div class="content">
      <div class="label text--black font-bold mb--1">
        {{ incident.name | truncate: trunc }}
      </div>
      <div class="label--small text--black">
        {{ incident.incident_status.name }} ‚Ä¢
        {% render "severity_badge", severity: incident.severity %} ‚Ä¢
        {{ incident.created_at | date: "%b %d %H:%M" }}
      </div>
    </div>
    {% if show %}
      <div class="flex flex--wrap gap--[4px] mt--1.5 text--black">
        {% for field in incident.custom_field_entries %}
          {% render "impact_badge_teams", field: field, limit: 2 %}
          {% render "impact_badge_services", field: field, limit: 2 %}
          {% render "impact_badge_users", field: field %}
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endtemplate %}


{% comment %}
  ============================================
  TITLE BAR
  ============================================
  Display title bar with logo and status (always shows status)

  Usage: {% render "title_bar", active: active_count %}
{% endcomment %}

{% template title_bar %}
  <div class="title_bar">
    <img class="image" src="https://incident.io/brand/resources/icon-dark.svg">
    <span class="title">Incident.io</span>
    <span class="instance">
      {% if active == 1 %}
        1 Active Incident
      {% elsif active > 1 %}
        {{ active }} Active Incidents
      {% else %}
        All Clear
      {% endif %}
    </span>
  </div>
{% endtemplate %}
